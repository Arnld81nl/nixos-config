#!/usr/bin/env bash
set -euo pipefail

cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/clipboard-images"
mkdir -p "$cache_dir"

mime="$(wl-paste --list-types | grep -E '^image/' | head -n 1 || true)"
if [[ -z "$mime" ]]; then
  echo "No image in clipboard." >&2
  exit 1
fi

case "$mime" in
  image/png) ext="png" ;;
  image/jpeg) ext="jpg" ;;
  image/webp) ext="webp" ;;
  image/gif) ext="gif" ;;
  image/bmp) ext="bmp" ;;
  image/tiff) ext="tiff" ;;
  *) ext="bin" ;;
esac

ts="$(date +%Y%m%d-%H%M%S)"
outfile="${cache_dir}/clipboard-${ts}.${ext}"

# Save image to file
wl-paste --type "$mime" --no-newline > "$outfile"

# Write path to 'latest' file for CLI tools that need it
echo "$outfile" > "${cache_dir}/latest"

# Copy plain file path to clipboard (for terminal apps like Claude Code)
printf '%s' "$outfile" | wl-copy
echo "Copied file path to clipboard: $outfile"
